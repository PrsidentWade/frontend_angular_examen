<div class="container-fluid p-0">
  <!-- Header Section -->
  <div class="d-flex justify-content-between align-items-center mb-4 p-4 bg-white rounded shadow-sm">
    <div>
      <h1 class="h3 mb-1 fw-bold text-dark">
        <i class="fas fa-tasks text-primary me-3"></i>Gestion des Tâches
      </h1>
      <p class="text-muted mb-0">Organisez et suivez l'avancement de vos tâches</p>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-primary d-flex align-items-center" (click)="chargerTaches()" [disabled]="loading">
        <i class="fas fa-sync-alt me-2" [class.fa-spin]="loading"></i>
        Actualiser
      </button>
      <button class="btn btn-primary d-flex align-items-center" (click)="ouvrirModalAjout()">
        <i class="fas fa-plus me-2"></i>
        Nouvelle Tâche
      </button>
    </div>
  </div>

  <!-- Search and Filters Section -->
  <div class="row g-3 mb-4">
    <div class="col-lg-6">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-3">
          <div class="input-group">
            <span class="input-group-text bg-light border-0">
              <i class="fas fa-search text-muted"></i>
            </span>
            <input type="text" class="form-control border-0 bg-light" placeholder="Rechercher une tâche...">
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-3">
          <div class="row g-2">
            <div class="col-4">
              <select class="form-select bg-light border-0">
                <option value="">Tous les statuts</option>
                <option value="a_faire">À faire</option>
                <option value="en_cours">En cours</option>
                <option value="termine">Terminé</option>
              </select>
            </div>
            <div class="col-4">
              <select class="form-select bg-light border-0">
                <option value="">Toutes les priorités</option>
                <option value="haute">Haute</option>
                <option value="moyenne">Moyenne</option>
                <option value="basse">Basse</option>
              </select>
            </div>
            <div class="col-4">
              <select class="form-select bg-light border-0">
                <option value="">Tous les projets</option>
                <option *ngFor="let p of projets" [value]="p.id">{{ p.nom_project }}</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Chargement...</span>
    </div>
    <p class="mt-3 text-muted">Chargement des tâches...</p>
  </div>

  <!-- Tasks Grid -->
  <div *ngIf="!loading" class="row g-4">
    <!-- Add New Task Card -->
    <div class="col-lg-4 col-md-6">
      <div class="card border-2 border-dashed border-primary h-100 d-flex align-items-center justify-content-center"
        style="min-height: 300px; cursor: pointer;" (click)="ouvrirModalAjout()">
        <div class="text-center text-primary">
          <i class="fas fa-plus-circle fa-3x mb-3"></i>
          <h5 class="fw-bold">Créer une nouvelle tâche</h5>
          <p class="text-muted">Cliquez pour ajouter une tâche</p>
        </div>
      </div>
    </div>

    <!-- Task Cards -->
    <div class="col-lg-4 col-md-6" *ngFor="let t of taches">
      <div class="card border-0 shadow-sm h-100 position-relative overflow-hidden task-card">
        <!-- Priority Indicator -->
        <div class="position-absolute top-0 start-0 w-100" style="height: 4px;">
          <div class="bg-warning w-100 h-100" *ngIf="t.priority === 'haute'"></div>
          <div class="bg-info w-100 h-100" *ngIf="t.priority === 'moyenne'"></div>
          <div class="bg-secondary w-100 h-100" *ngIf="t.priority === 'basse'"></div>
        </div>

        <!-- Card Header -->
        <div class="card-header bg-transparent border-0 pb-2 pt-4">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <h5 class="card-title mb-1 fw-bold">{{ t.titre }}</h5>
              <span class="badge rounded-pill" [ngClass]="{
                      'bg-warning text-dark': t.etat === 'a_faire',
                      'bg-info text-white': t.etat === 'en_cours',
                      'bg-success text-white': t.etat === 'termine'
                    }">
                <i class="fas fa-circle me-1" style="font-size: 0.5rem;"></i>
                {{ getLabelEtat(t.etat) }}
              </span>
            </div>
            <div class="dropdown">
              <button class="btn btn-sm btn-outline-secondary border-0" data-bs-toggle="dropdown">
                <i class="fas fa-ellipsis-v"></i>
              </button>
              <ul class="dropdown-menu">
                <li>
                  <a class="dropdown-item" (click)="ouvrirModalModification(t)">
                    <i class="fas fa-edit me-2"></i>Modifier
                  </a>
                </li>
                <li>
                  <hr class="dropdown-divider">
                </li>
                <li>
                  <a class="dropdown-item text-danger" (click)="ouvrirModalSuppression(t)">
                    <i class="fas fa-trash me-2"></i>Supprimer
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Card Body -->
        <div class="card-body pt-0">
          <p class="text-muted mb-3"
            style="display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">
            {{ t.description }}
          </p>

          <!-- Task Meta Information -->
          <div class="row g-2 mb-3">
            <div class="col-12" *ngIf="t.deadline">
              <div class="d-flex align-items-center text-muted small">
                <i class="fas fa-calendar-alt me-2 text-warning"></i>
                <span>{{ t.deadline | date: 'dd/MM/yyyy à HH:mm' }}</span>
              </div>
            </div>
            <div class="col-12" *ngIf="t.project?.nom_project">
              <div class="d-flex align-items-center text-muted small">
                <i class="fas fa-folder me-2 text-primary"></i>
                <span>{{ t.project?.nom_project }}</span>
              </div>
            </div>
            <div class="col-12" *ngIf="t.assignee?.name">
              <div class="d-flex align-items-center text-muted small">
                <i class="fas fa-user me-2 text-info"></i>
                <span>{{ t.assignee?.name }}</span>
              </div>
            </div>
          </div>

          <!-- Progress Bar (example) -->
          <div class="mb-3" *ngIf="t.etat === 'en_cours'">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <small class="text-muted">Progression</small>
              <small class="text-muted">65%</small>
            </div>
            <div class="progress" style="height: 6px;">
              <div class="progress-bar bg-info" style="width: 65%"></div>
            </div>
          </div>
        </div>

        <!-- Card Footer -->
        <div class="card-footer bg-transparent border-0">
          <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">
              <i class="fas fa-clock me-1"></i>
              {{ t.created_at | date: 'dd/MM/yyyy' }}
            </small>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" (click)="ouvrirModalModification(t)" title="Modifier">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-outline-danger" (click)="ouvrirModalSuppression(t)" title="Supprimer">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loading && taches.length === 0" class="text-center py-5">
    <div class="mb-4">
      <i class="fas fa-tasks text-muted" style="font-size: 4rem; opacity: 0.3;"></i>
    </div>
    <h4 class="text-muted mb-3">Aucune tâche trouvée</h4>
    <p class="text-muted mb-4">Commencez par créer votre première tâche pour organiser votre travail</p>
    <button class="btn btn-primary" (click)="ouvrirModalAjout()">
      <i class="fas fa-plus me-2"></i>
      Créer ma première tâche
    </button>
  </div>
</div>

<!-- Modern Add/Edit Modal -->
<div class="modal fade" [class.show]="showModal" [style.display]="showModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <!-- Modal Header -->
      <div class="modal-header border-0 pb-0">
        <div>
          <h4 class="modal-title fw-bold mb-1">
            <i class="fas fa-{{ isEditing ? 'edit' : 'plus' }} text-primary me-2"></i>
            {{ isEditing ? 'Modifier la tâche' : 'Nouvelle tâche' }}
          </h4>
          <p class="text-muted small mb-0">
            {{ isEditing ? 'Modifiez les informations de votre tâche' : 'Créez une nouvelle tâche pour votre projet' }}
          </p>
        </div>
        <button type="button" class="btn-close" (click)="fermerModal()"></button>
      </div>

      <!-- Modal Body -->
      <form [formGroup]="tacheForm" (ngSubmit)="onSubmit()">
        <div class="modal-body pt-4">
          <div class="row g-4">
            <!-- Title and Status -->
            <div class="col-md-8">
              <label for="titre" class="form-label fw-semibold">
                <i class="fas fa-heading text-primary me-2"></i>Titre de la tâche *
              </label>
              <input type="text" class="form-control form-control-lg" id="titre" formControlName="titre"
                [class.is-invalid]="hasError('titre')" placeholder="Ex: Développer la page d'accueil">
              <div class="invalid-feedback" *ngIf="hasError('titre')">
                {{ getErrorMessage('titre') }}
              </div>
            </div>

            <div class="col-md-4">
              <label for="etat" class="form-label fw-semibold">
                <i class="fas fa-flag text-success me-2"></i>Statut *
              </label>
              <select class="form-select form-select-lg" id="etat" formControlName="etat"
                [class.is-invalid]="hasError('etat')">
                <option value="a_faire">🔵 À faire</option>
                <option value="en_cours">🟡 En cours</option>
                <option value="termine">🟢 Terminé</option>
              </select>
              <div class="invalid-feedback" *ngIf="hasError('etat')">
                {{ getErrorMessage('etat') }}
              </div>
            </div>

            <!-- Description -->
            <div class="col-12">
              <label for="description" class="form-label fw-semibold">
                <i class="fas fa-align-left text-info me-2"></i>Description *
              </label>
              <textarea class="form-control" id="description" formControlName="description"
                [class.is-invalid]="hasError('description')" rows="4"
                placeholder="Décrivez les détails de cette tâche..."></textarea>
              <div class="invalid-feedback" *ngIf="hasError('description')">
                {{ getErrorMessage('description') }}
              </div>
            </div>

            <!-- Project and Assignee -->
            <div class="col-md-6">
              <label for="project_id" class="form-label fw-semibold">
                <i class="fas fa-folder text-warning me-2"></i>Projet *
              </label>
              <select class="form-select" id="project_id" formControlName="project_id"
                [class.is-invalid]="hasError('project_id')">
                <option value="">Sélectionner un projet</option>
                <option *ngFor="let p of projets" [value]="p.id">
                  📁 {{ p.nom_project }}
                </option>
              </select>
              <div class="invalid-feedback" *ngIf="hasError('project_id')">
                {{ getErrorMessage('project_id') }}
              </div>
            </div>

            <div class="col-md-6">
              <label for="assigned_to" class="form-label fw-semibold">
                <i class="fas fa-user text-purple me-2"></i>Assigné à *
              </label>
              <select class="form-select" id="assigned_to" formControlName="assigned_to"
                [class.is-invalid]="hasError('assigned_to')">
                <option value="">Sélectionner un utilisateur</option>
                <option *ngFor="let u of users" [value]="u.id">
                  👤 {{ u.name }}
                </option>
              </select>
              <div class="invalid-feedback" *ngIf="hasError('assigned_to')">
                {{ getErrorMessage('assigned_to') }}
              </div>
            </div>

            <!-- Deadline -->
            <div class="col-md-6">
              <label for="deadline" class="form-label fw-semibold">
                <i class="fas fa-calendar-alt text-danger me-2"></i>Date limite
              </label>
              <input type="datetime-local" class="form-control" id="deadline" formControlName="deadline">
              <div class="form-text">
                <i class="fas fa-info-circle me-1"></i>Laissez vide si pas de date limite
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label fw-semibold">
                <i class="fas fa-exclamation-triangle text-warning me-2"></i>Priorité
              </label>
              <div class="d-flex gap-2">
                <input type="radio" class="btn-check" name="priority" id="priority-high" value="haute">
                <label class="btn btn-outline-danger" for="priority-high">🔴 Haute</label>

                <input type="radio" class="btn-check" name="priority" id="priority-medium" value="moyenne" checked>
                <label class="btn btn-outline-warning" for="priority-medium">🟡 Moyenne</label>

                <input type="radio" class="btn-check" name="priority" id="priority-low" value="basse">
                <label class="btn btn-outline-secondary" for="priority-low">⚪ Basse</label>
              </div>
            </div>
          </div>
        </div>

        <!-- Modal Footer -->
        <div class="modal-footer border-0 pt-0">
          <button type="button" class="btn btn-light" (click)="fermerModal()">
            <i class="fas fa-times me-2"></i>Annuler
          </button>
          <button type="submit" class="btn btn-primary btn-lg" [disabled]="tacheForm.invalid">
            <i class="fas fa-{{ isEditing ? 'save' : 'plus' }} me-2"></i>
            {{ isEditing ? 'Sauvegarder' : 'Créer la tâche' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div class="modal-backdrop fade show" *ngIf="showModal" (click)="fermerModal()"></div>

<!-- Modern Delete Confirmation Modal -->
<div class="modal fade" [class.show]="showDeleteModal" [style.display]="showDeleteModal ? 'block' : 'none'"
  tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold">
          <i class="fas fa-exclamation-triangle text-danger me-2"></i>
          Confirmer la suppression
        </h5>
        <button type="button" class="btn-close" (click)="fermerModalSuppression()"></button>
      </div>

      <div class="modal-body text-center py-4">
        <div class="mb-4">
          <i class="fas fa-trash-alt text-danger" style="font-size: 3rem; opacity: 0.7;"></i>
        </div>
        <h6 class="fw-bold mb-3">Êtes-vous sûr de vouloir supprimer cette tâche ?</h6>
        <div class="bg-light rounded p-3 mb-3">
          <strong class="text-primary">"{{ tacheToDelete?.titre }}"</strong>
        </div>
        <p class="text-muted small mb-0">
          Cette action est irréversible. Toutes les données associées seront définitivement perdues.
        </p>
      </div>

      <div class="modal-footer border-0 pt-0">
        <button type="button" class="btn btn-light" (click)="fermerModalSuppression()">
          <i class="fas fa-times me-2"></i>Annuler
        </button>
        <button type="button" class="btn btn-danger" (click)="confirmerSuppression()">
          <i class="fas fa-trash me-2"></i>Supprimer définitivement
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Modal Backdrop -->
<div class="modal-backdrop fade show" *ngIf="showDeleteModal" (click)="fermerModalSuppression()"></div>

<style>
  .task-card {
    transition: all 0.3s ease;
  }

  .task-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
  }

  .text-purple {
    color: #6f42c1 !important;
  }

  .bg-light {
    background-color: #f8f9fa !important;
  }
</style>